FIX QUEUE NUMBERING AND STATUS FLOW - CRITICAL ISSUES

PROBLEMS TO FIX:

1. Customer showing as #47 but is actually #1 in queue
2. Admin panel showing #47 instead of #1 in Active Queue
3. When admin confirms booking (Call Now), it should move to Recent Activity
4. When admin clicks "Finish" in Active Queue, booking should:
   - Disappear from Active Queue
   - Appear in Recent Activity with COMPLETED status

COMPLETE FIX IMPLEMENTATION:

═══════════════════════════════════════════════════════════════
ISSUE 1: FIX QUEUE POSITION DISPLAY (SHOWING #47 INSTEAD OF #1)
═══════════════════════════════════════════════════════════════

BACKEND - Fix queue position calculation for BOTH customer and admin:
```javascript
// Function to calculate actual queue position
async function calculateQueuePosition(bookingId) {
  const currentBooking = await Booking.findById(bookingId);
  
  if (!currentBooking || currentBooking.status !== 'WAITING') {
    return null;
  }
  
  // Count how many WAITING bookings were created BEFORE this one
  const bookingsAhead = await Booking.countDocuments({
    status: 'WAITING',
    createdAt: { $lt: currentBooking.createdAt }
  });
  
  return bookingsAhead + 1; // +1 because position starts from 1, not 0
}

// Route: GET /api/bookings/status/:id (for customer confirmation page)
router.get('/bookings/status/:id', async (req, res) => {
  try {
    const booking = await Booking.findById(req.params.id);
    
    if (!booking) {
      return res.status(404).json({ error: 'Booking not found' });
    }
    
    // Calculate ACTUAL queue position
    const queuePosition = await calculateQueuePosition(req.params.id);
    
    res.json({
      booking: booking,
      queuePosition: queuePosition, // This will be 1, not 47
      status: booking.status
    });
    
  } catch (error) {
    res.status(500).json({ error: 'Failed to fetch booking status' });
  }
});

// Route: GET /api/bookings/by-date (for admin Active Queue)
router.get('/bookings/by-date', async (req, res) => {
  try {
    const { date } = req.query;
    const targetDate = date ? new Date(date) : new Date();
    
    const startOfDay = new Date(targetDate);
    startOfDay.setHours(0, 0, 0, 0);
    
    const endOfDay = new Date(targetDate);
    endOfDay.setHours(23, 59, 59, 999);
    
    // Get all WAITING bookings for the day
    const bookings = await Booking.find({
      status: 'WAITING',
      createdAt: {
        $gte: startOfDay,
        $lte: endOfDay
      }
    })
    .sort({ createdAt: 1 }) // Oldest first
    .exec();
    
    // Add sequential queue position to each booking
    const bookingsWithPosition = bookings.map((booking, index) => ({
      ...booking.toObject(),
      queuePosition: index + 1  // #1, #2, #3, #4...
    }));
    
    res.json({
      bookings: bookingsWithPosition,
      totalWaiting: bookingsWithPosition.length,
      date: targetDate.toISOString().split('T')[0]
    });
    
  } catch (error) {
    res.status(500).json({ error: 'Failed to fetch bookings' });
  }
});
```

FRONTEND - Customer Confirmation Page (Image showing #47):
```javascript
// WRONG - Don't use this:
<h1>#{booking._id}</h1>
<h1>#{booking.bookingNumber}</h1>

// CORRECT - Use calculated queue position:
<h1>#{queuePosition}</h1>

// Full component example:
function ConfirmationPage({ bookingId }) {
  const [queuePosition, setQueuePosition] = useState(null);
  const [booking, setBooking] = useState(null);
  
  useEffect(() => {
    const fetchStatus = async () => {
      const response = await fetch(`/api/bookings/status/${bookingId}`);
      const data = await response.json();
      setQueuePosition(data.queuePosition);
      setBooking(data.booking);
    };
    
    fetchStatus();
  }, [bookingId]);
  
  return (
    <div>
      <h1>You're Confirmed!</h1>
      <p>Thanks {booking?.name}. Please head to the counter and show this screen.</p>
      
      <div className="queue-number-box">
        <p>QUEUE NUMBER</p>
        <h1>#{queuePosition}</h1>  {/* Shows #1, not #47 */}
      </div>
      
      <p>Cafe 2020 Main Counter</p>
    </div>
  );
}
```

FRONTEND - Admin Active Queue Table:
```javascript
// Display queue position in table
<table>
  <thead>
    <tr>
      <th>#</th>
      <th>Customer</th>
      {/* ... other columns ... */}
    </tr>
  </thead>
  <tbody>
    {bookings.map((booking) => (
      <tr key={booking._id}>
        <td>#{booking.queuePosition}</td>  {/* Shows #1, #2, #3... not #47 */}
        <td>{booking.name}</td>
        {/* ... other columns ... */}
      </tr>
    ))}
  </tbody>
</table>
```

═══════════════════════════════════════════════════════════════
ISSUE 2: WHEN ADMIN CLICKS "CALL NOW" → MOVE TO RECENT ACTIVITY
═══════════════════════════════════════════════════════════════

BACKEND - Update the Call Now / Confirm button action:
```javascript
// Route: PATCH /api/bookings/:id/call-now
router.patch('/bookings/:id/call-now', async (req, res) => {
  try {
    const booking = await Booking.findById(req.params.id);
    
    if (!booking) {
      return res.status(404).json({ error: 'Booking not found' });
    }
    
    // Change status from WAITING to CALLED or CONFIRMED
    booking.status = 'CALLED';  // or 'CONFIRMED' - choose one
    booking.calledAt = new Date();
    booking.updatedAt = new Date();
    await booking.save();
    
    // This booking will now appear in Recent Activity
    // because Recent Activity shows all non-WAITING bookings
    
    res.json({
      success: true,
      message: 'Customer has been called',
      booking: booking
    });
    
  } catch (error) {
    res.status(500).json({ error: 'Failed to update booking' });
  }
});
```

This booking will AUTOMATICALLY appear in Recent Activity because:
- Recent Activity query: `status: { $ne: 'WAITING' }`
- After Call Now: status = 'CALLED' (not WAITING)
- Therefore: Shows in Recent Activity ✅

═══════════════════════════════════════════════════════════════
ISSUE 3: "FINISH" BUTTON - REMOVE FROM ACTIVE QUEUE, ADD TO RECENT ACTIVITY
═══════════════════════════════════════════════════════════════

BACKEND - Add Finish button action:
```javascript
// Route: PATCH /api/bookings/:id/finish
router.patch('/bookings/:id/finish', async (req, res) => {
  try {
    const booking = await Booking.findById(req.params.id);
    
    if (!booking) {
      return res.status(404).json({ error: 'Booking not found' });
    }
    
    // Mark as COMPLETED
    booking.status = 'COMPLETED';
    booking.completedAt = new Date();
    booking.updatedAt = new Date();
    await booking.save();
    
    res.json({
      success: true,
      message: 'Booking marked as completed',
      booking: booking
    });
    
  } catch (error) {
    res.status(500).json({ error: 'Failed to complete booking' });
  }
});
```

FRONTEND - Add Finish button in Active Queue:
```javascript
// In Active Queue table Actions column
<td>
  <button onClick={() => handleCallNow(booking._id)}>
    Call Now
  </button>
  
  <button onClick={() => handleFinish(booking._id)}>
    Finish
  </button>
  
  <button onClick={() => handleCancel(booking._id)}>
    Cancel
  </button>
</td>

// Handler function
const handleFinish = async (bookingId) => {
  try {
    const response = await fetch(`/api/bookings/${bookingId}/finish`, {
      method: 'PATCH'
    });
    
    if (response.ok) {
      // Refresh the Active Queue list
      fetchActiveQueue();
      alert('Booking completed successfully!');
    }
  } catch (error) {
    console.error('Error finishing booking:', error);
  }
};
```

RESULT:
- Before: Booking in Active Queue with status WAITING
- After Finish: Booking disappears from Active Queue (because status ≠ WAITING)
- After Finish: Booking appears in Recent Activity with COMPLETED status

═══════════════════════════════════════════════════════════════
COMPLETE STATUS FLOW DIAGRAM
═══════════════════════════════════════════════════════════════

1. Customer fills form → Status: WAITING → Shows in Active Queue as #1, #2, #3...

2. Admin clicks "Call Now" → Status: CALLED → Booking moves to Recent Activity

3. Customer clicks "I'm Coming!" → Status: CONFIRMED → Stays in Recent Activity

4. Admin clicks "Finish" → Status: COMPLETED → Moves to Recent Activity

5. Customer clicks "Leave Queue" → Status: LEAVE → Moves to Recent Activity

6. Anyone clicks "Cancel" → Status: CANCELLED → Moves to Recent Activity

ACTIVE QUEUE SHOWS:
- Only bookings with status = 'WAITING'
- Numbered sequentially: #1, #2, #3, #4...

RECENT ACTIVITY SHOWS:
- All bookings with status ≠ 'WAITING'
- Includes: CALLED, CONFIRMED, COMPLETED, LEAVE, CANCELLED
- Sorted by updatedAt (most recent first)

═══════════════════════════════════════════════════════════════
DATABASE SCHEMA UPDATE (if needed)
═══════════════════════════════════════════════════════════════
```javascript
const bookingSchema = new mongoose.Schema({
  name: String,
  phone: String,
  numberOfPeople: Number,
  specialRequests: String,
  
  status: {
    type: String,
    enum: ['WAITING', 'CALLED', 'CONFIRMED', 'COMPLETED', 'CANCELLED', 'LEAVE'],
    default: 'WAITING'
  },
  
  // Timestamps for different actions
  createdAt: { type: Date, default: Date.now },
  updatedAt: { type: Date, default: Date.now },
  calledAt: Date,
  confirmedAt: Date,
  completedAt: Date,
  cancelledAt: Date,
  leftAt: Date
});
```

═══════════════════════════════════════════════════════════════
TESTING CHECKLIST
═══════════════════════════════════════════════════════════════

Active Queue:
- [ ] Shows only WAITING bookings
- [ ] Queue numbers are #1, #2, #3 (not #47, #48, #49)
- [ ] "Call Now" button removes booking from Active Queue
- [ ] "Finish" button removes booking from Active Queue
- [ ] Queue numbers auto-adjust when someone leaves

Recent Activity:
- [ ] Shows CALLED bookings (after Call Now)
- [ ] Shows CONFIRMED bookings (after customer confirms)
- [ ] Shows COMPLETED bookings (after Finish)
- [ ] Shows CANCELLED bookings
- [ ] Shows LEAVE bookings
- [ ] Sorted by most recent first

Customer Page:
- [ ] Shows correct queue position (#1, not #47)
- [ ] Updates in real-time (with polling)
- [ ] Shows promotion notification when moving up

═══════════════════════════════════════════════════════════════
IMPORTANT NOTES
═══════════════════════════════════════════════════════════════

✅ NEVER use booking._id for queue position
✅ NEVER use total booking count for queue position
✅ ALWAYS calculate position by counting WAITING bookings before current booking
✅ Position = COUNT(WAITING bookings with createdAt < current.createdAt) + 1
✅ Active Queue = status WAITING only
✅ Recent Activity = status NOT WAITING
✅ Keep all other functionality exactly as it is

DEPLOY THIS FIX TO SOLVE ALL QUEUE NUMBERING AND FLOW ISSUES.